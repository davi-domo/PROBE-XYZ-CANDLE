<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Générateur de probe</title>
    <style>
        body {
            background-color: #ffffff;
        }

        .titre {
            position: relative;
            text-align: center;
            border: none;
            font-size: 44px;
            height: 30px;
            min-width: 980px;
        }

        .visu {
            position: relative;
            top: 0;
            border: none;
            width: 100%;
            min-width: 980px;
            height: 800px;
            overflow: auto;
        }

        .conteneur {

            width: 980px;
            min-width: 980px;
            position: absolute;
            left: 50%;
            top: 0;
            transform: translate(-50%);

        }

        .probe {
            position: absolute;
            top: 0px;
            left: 10px;
            background-image: url(./img/PROBE_XYZ.png);
            background-repeat: no-repeat;
            width: 600px;
            height: 400px;
        }

        .input_x_probe {
            position: absolute;
            top: 15px;
            left: 40px;
        }

        .input_x_lon {
            position: absolute;
            top: 22px;
            left: 290px;
        }

        .input_d_trou {
            position: absolute;
            top: 87px;
            left: 290px;
        }

        .input_y_probe {
            position: absolute;
            top: 301px;
            left: 290px;
        }

        .input_y_lon {
            position: absolute;
            top: 173px;
            left: 290px;
        }

        .input_z_probe {
            position: absolute;
            top: 283px;
            left: 500px;
        }

        .fraise {
            position: absolute;
            top: 18px;
            left: 620px;
            background-image: url(./img/er11.png);
            background-repeat: no-repeat;
            width: 323px;
            height: 400px;
        }

        .input_fraise {
            position: absolute;
            top: 340px;
            left: 160px;
        }

        .generate {
            position: absolute;
            white-space: pre-wrap;
            top: 470px;
            left: 10px;
            width: 960px;
            height: 300px;
            overflow: auto;
            padding: 5px;
            margin: 5px;
            border: 1px solid #b8bbbe;
            -webkit-border-radius: 5px;
            border-radius: 5px;
        }

        .gen_XYZ {
            position: absolute;
            top: 440px;
            left: 25px;
            width: 200px;
        }

        .gen_z_probe {
            position: absolute;
            top: 440px;
            left: 235px;
            width: 200px;
        }

        .gen_command_probe_XYZ {
            position: absolute;
            top: 440px;
            left: 445px;
            width: 200px;
        }

        .gen_command_probe_XY {
            position: absolute;
            top: 440px;
            left: 655px;
            width: 200px;
        }

        .copy {
            position: absolute;
            top: 750px;
            left: 780px
        }

        .save {
            position: absolute;
            top: 750px;
            left: 870px
        }

        .link{
            position: relative;
            margin-left:25px;
            top: 400px;
        }

        label {
            font-size: 22px;
            color: #3b6692;
        }

        input[type=number] {
            padding: 5px 15px;
            background: #3b6692;
            color: #ffffff;
            font-weight: bold;
            border: 2px solid #3b6692;
            cursor: pointer;
            -webkit-border-radius: 5px;
            border-radius: 5px;
        }

        .input_saisie {
            width: 50px;
        }

        input[type=button] {
            padding: 5px 15px;
            background: #248FFB;
            color: #ffffff;
            font-weight: bold;
            border: none;
            cursor: pointer;
            -webkit-border-radius: 5px;
            border-radius: 5px;
        }

        input[type=button]:hover {
            background: #52a0ee;
        }
    </style>
</head>

<body>

</html>
<div class="titre">Générateur de probe pour GRBL 1.1</div>
<div class="visu">
    <div class="conteneur">
        <div class="probe">
            <div class="input_x_probe">
                <label for="x_probe">Déport X</label><br>
                <input type="number" name="x_probe" id="x_probe" min="0.01" step="0.01" max="50" class="input_saisie">
            </div>
            <div class="input_x_lon">
                <label for="x_lon">Course X</label><br>
                <input type="number" name="x_lon" id="x_lon" min="1" step="1" max="50" value="25" class="input_saisie">
            </div>
            <div class="input_d_trou">
                <input type="number" name="d_trou" id="d_trou" min="0.01" step="0.01" max="50" value="14"
                    class="input_saisie"><br>
                <label for="d_trou">&#8960; Trou probe</label>
            </div>
            <div class="input_y_probe">
                <label for="y_probe">Déport Y</label><br>
                <input type="number" name="y_probe" id="y_probe" min="0.01" step=0.01 max="50" class="input_saisie">
            </div>
            <div class="input_y_lon">
                <label for="y_lon">Course Y</label><br>
                <input type="number" name="y_lon" id="y_lon" min="1" step="1" max="50" value="25" class="input_saisie">
            </div>
            <div class="input_z_probe">
                <label for="z_probe">Déport Z</label><br>
                <input type="number" name="z_probe" id="z_probe" min="0.01" step="0.01" max="50" class="input_saisie">
            </div>
            <a href="https://github.com/davi-domo/PROBE-XYZ-CANDLE" target="_blank" class="link">git projet</a>
            <a href="https://github.com/davi-domo/Candle" target="_blank" class="link">CANDLE 1.1.7</a>
            <a href="https://github.com/davi-domo/PROBE-XYZ-CANDLE/blob/main/Candle_1.2.7.zip" target="_blank" class="link">CANDLE 1.2.7</a>
        </div>
        <div class="fraise">
            <div class="input_fraise">
                <label for="d_fraise">&#8960; fraise</label><br>
                <input type="number" name="d_fraise" id="d_fraise" min=0 step=0.01 max="50" class="input_saisie">
            </div>
        </div>
        <input type="button" id="gen_xyz" value="GCODE probe XYZ" class="gen_XYZ" title="Pour candle 1.1.x et 1.2.7">
        <input type="button" id="gen_z_probe" value="Commande probe Z" class="gen_z_probe"
            title="Pour candle 1.1.x et 1.2.7">
        <input type="button" id="gen_command_probe_xyz" value="User commands probe XYZ" class="gen_command_probe_XYZ"
            title="Pour candle 1.2.7">
        <input type="button" id="gen_command_probe_xy" value="User commands probe XY" class="gen_command_probe_XY"
            title="Pour candle 1.2.7">
        <div id="gcode" class="generate"></div>
        <input type="button" id="save" value="Télécharger" class="save">
        <input type="button" id="copy" value="Copier" class="copy">
    </div>
</div>
</body>
<script>
    // declaration des variables 
    let input_x_probe = document.querySelector("#x_probe");
    let input_y_probe = document.querySelector("#y_probe");
    let input_z_probe = document.querySelector("#z_probe");
    let input_d_fraise = document.querySelector("#d_fraise");
    let input_x_lon = document.querySelector("#x_lon");
    let input_y_lon = document.querySelector("#y_lon");
    let input_d_trou = document.querySelector("#d_trou");
    let x_probe;
    let y_probe;
    let z_probe;
    let d_fraise;
    let x_lon;
    let y_lon;
    let d_trou;
    let filename = "defaut.nc";
    // Affichage des valeur enregistrer
    input_x_probe.value = localStorage.getItem("x_probe");
    input_y_probe.value = localStorage.getItem("y_probe");
    input_z_probe.value = localStorage.getItem("z_probe");
    input_d_fraise.value = localStorage.getItem("d_fraise");
    if (localStorage.getItem("d_trou") != null && localStorage.getItem("d_trou").length != 0) {
        input_d_trou.value = localStorage.getItem("d_trou");
    }
    if (localStorage.getItem("x_lon") != null && localStorage.getItem("x_lon").length != 0) {
        input_x_lon.value = localStorage.getItem("x_lon");
    }
    if (localStorage.getItem("y_lon") != null && localStorage.getItem("y_lon").length != 0) {
        input_y_lon.value = localStorage.getItem("y_lon");
    }
    // fonction de verification des champs
    function verif_form() {
        input_x_probe.style.border = "2px solid #3b6692";
        input_y_probe.style.border = "2px solid #3b6692";
        input_z_probe.style.border = "2px solid #3b6692";
        input_d_fraise.style.border = "2px solid #3b6692";
        input_x_lon.style.border = "2px solid #3b6692";
        input_y_lon.style.border = "2px solid #3b6692";
        input_d_trou.style.border = "2px solid #3b6692";
        let error_input = false;
        let message_error = "";
        if (input_x_probe.value.length == 0 || parseFloat(input_x_probe.value) >= 50.01) {
            input_x_probe.style.border = "2px solid #ff5757";
            message_error += "Le champ Déport X est vide ou supérieur à 50\n"
            error_input = true;
        }
        if (input_y_probe.value.length == 0 || parseFloat(input_y_probe.value) >= 50.01) {
            input_y_probe.style.border = "2px solid #ff5757";
            message_error += "Le champ Déport Y est vide ou supérieur à 50\n"
            error_input = true;
        }
        if (input_z_probe.value.length == 0 || parseFloat(input_z_probe.value) >= 50.01) {
            input_z_probe.style.border = "2px solid #ff5757";
            message_error += "Le champ Déport Z est vide ou supérieur à 50\n"
            error_input = true;
        }
        if (input_d_fraise.value.length == 0 || parseFloat(input_d_fraise.value) >= 50.01) {
            input_d_fraise.style.border = "2px solid #ff5757";
            message_error += "Le champ ⌀ fraise est vide ou supérieur à 50\n"
            error_input = true;
        }
        if (input_x_lon.value.length == 0 || parseInt(input_x_lon.value) >= 51) {
            input_x_lon.style.border = "2px solid #ff5757";
            message_error += "Le champ Course X est vide ou supérieur à 50\n"
            error_input = true;
        }
        if (input_y_lon.value.length == 0 || parseInt(input_y_lon.value) >= 51) {
            input_y_lon.style.border = "2px solid #ff5757";
            message_error += "Le champ Course Y est vide ou supérieur à 50\n"
            error_input = true;
        }
        if (input_d_trou.value.length == 0 || parseFloat(input_d_trou.value) >= 50.01) {
            input_d_trou.style.border = "2px solid #ff5757";
            message_error += "Le champ ⌀ Trou probe est vide ou supérieur à 50\n"
            error_input = true;
        }
        if (error_input === true) {
            alert(message_error);
            return false;
        }
        if (error_input === false) {

            //on enregistre les valeurs

            x_probe = input_x_probe.value;
            y_probe = input_y_probe.value;
            z_probe = input_z_probe.value;
            d_fraise = input_d_fraise.value;
            x_lon = input_x_lon.value;
            y_lon = input_y_lon.value;
            d_trou = input_d_trou.value;
            localStorage.setItem("x_probe", x_probe);
            localStorage.setItem("y_probe", y_probe);
            localStorage.setItem("z_probe", z_probe);
            localStorage.setItem("d_fraise", d_fraise);
            localStorage.setItem("x_lon", x_lon);
            localStorage.setItem("y_lon", y_lon);
            localStorage.setItem("d_trou", y_lon);
            return true;

        }
    }

    // action sur le bouton GCODE probe XYZ
    document.querySelector("#gen_xyz").onclick = function () {
        // on verifi le formulaire
        if (verif_form() === false) { return; }

        // on genere le GCODE
        let gcode = ";GCODE probe XYZ pour fraise de : " + d_fraise + " mm\n";
        gcode += "G91" + "\n";//position relative
        gcode += "G21" + "\n";// declation en millimetre
        gcode += "G38.2 Z-100 F100" + "\n";// Palpage rapide Z
        gcode += "G91 G0 Z1" + "\n";// mise en sécurité
        gcode += "G38.2 Z-50 F10" + "\n";// Palpage lent Z
        gcode += "G91 G0 Z" + ((Number(z_probe) + 2) - Number(z_probe)).toFixed(2) + "\n";// calcul de la mise en securité
        gcode += "G92 Z" + (Number(z_probe) + 2) + "\n";// mise en sécurité
        gcode += "G4 P0.01" + "\n";// pause de 10 millisecondes
        gcode += "G91 G0 Y-" + (Number(y_lon) + 1) + "\n";// on deplace l'axe Y
        gcode += "G4 P0.01" + "\n";// pause de 10 millisecondes
        gcode += "G91 Z-" + (Number(3) + Number(z_probe)).toFixed(2) + "\n";// on deplace l'axe z de 7 + hauteur z-probe
        gcode += "G38.2 Y" + (Number(y_lon) + 1) + " F100" + "\n";// Palpage rapide Y
        gcode += "G91 G0 Y-1" + "\n";// mise en sécurité
        gcode += "G38.2 Y3 F10" + "\n";// Palpage LENT Y
        gcode += "G92 Y-" + (Number(y_probe) + (Number(d_fraise) / 2)).toFixed(2) + "\n";// on enregistre largeur du palpeur + diametre fraise/2
        gcode += "G91 G0 Y-2" + "\n";// mise en sécurité
        gcode += "G4 P0.01" + "\n";// pause de 10 millisecondes
        gcode += "G91 G0 X-" + (Number(x_lon) + 1 ) + "\n";// on deplace l'axe x
        gcode += "G4 P0.01" + "\n";// pause de 10 millisecondes
        gcode += "G91 G0 Y" + (Number(y_lon) + 1 ) + "\n";// on deplace l'axe Y
        gcode += "G38.2 X" + (Number(x_lon) + 1 ) + " F100" + "\n";// Palpage rapide X
        gcode += "G91 G0 X-1" + "\n";// mise en sécurité
        gcode += "G38.2 X3 F10" + "\n";// Palpage LENT Y
        gcode += "G92 X-" + (Number(x_probe) + (Number(d_fraise) / 2)).toFixed(2) + "\n";// on enregistre largeur du palpeur + diametre fraise/2
        gcode += "G91 G0 X-2" + "\n";// mise en sécurité
        gcode += "G4 P0.01" + "\n";// pause de 10 millisecondes
        gcode += "G90" + "\n"; // on repasse en mode absolue
        gcode += "G0 Z" + (Number(z_probe) + 2) + "\n"; // mise en sécurité de l'axe Z
        gcode += "G0 X0 Y0" + "\n"; // on place X & Y en 0,0
        gcode += "M30"; // Fin de programme
        document.getElementById('gcode').innerHTML = gcode;
        filename = "GCODE_PROBE_XYZ_FRAISE_D-" + d_fraise + "mm.nc";
    };


    // action sur le bouton Commande probe Z
    document.querySelector("#gen_z_probe").onclick = function () {
        // on verifi le formulaire
        if (verif_form() === false) { return; }

        // on genere le GCODE
        let gcode = "G91G21G38.2Z-50F50; G92 Z" + Number(z_probe) + "; G0Z5M30";
        document.getElementById('gcode').innerHTML = gcode;
        filename = "PROBE_Z_H-" + z_probe + "mm.nc";
    };

// action sur le bouton gen_command_probe_xyz
document.querySelector("#gen_command_probe_xyz").onclick = function () {
    // on verifi le formulaire
    if (verif_form() === false) { return; }

    // on genere le GCODE
    let gcode = "G91" + ";\n";//position relative
    gcode += "G21" + ";\n";// declation en millimetre
    gcode += "G38.2 Z-100 F100" + ";\n";// Palpage rapide Z
    gcode += "G91 G0 Z1" + ";\n";// mise en sécurité
    gcode += "G38.2 Z-50 F10" + ";\n";// Palpage lent Z
    gcode += "G91 G0 Z" + ((Number(z_probe) + 2) - Number(z_probe)).toFixed(2) + ";\n";// calcul de la mise en securité
    gcode += "G92 Z" + (Number(z_probe) + 2) + ";\n";// mise en sécurité
    gcode += "G4 P0.01" + "\n";// pause de 10 millisecondes
    gcode += "G91 G0 Y-" + (Number(y_lon) + 1) + ";\n";// on deplace l'axe Y
    gcode += "G4 P0.01" + "\n";// pause de 10 millisecondes
    gcode += "G91 Z-" + (Number(3) + Number(z_probe)).toFixed(2) + ";\n";// on deplace l'axe z de 7 + hauteur z-probe
    gcode += "G38.2 Y" + (Number(y_lon) + 1) + " F100" + ";\n";// Palpage rapide Y
    gcode += "G91 G0 Y-1" + ";\n";// mise en sécurité
    gcode += "G38.2 Y3 F10" + ";\n";// Palpage LENT Y
    gcode += "G92 Y-" + (Number(y_probe) + (Number(d_fraise) / 2)).toFixed(2) + ";\n";// on enregistre largeur du palpeur + diametre fraise/2
    gcode += "G91 G0 Y-2" + ";\n";// mise en sécurité
    gcode += "G4 P0.01" + ";\n";// pause de 10 millisecondes
    gcode += "G91 G0 X-" + (Number(x_lon) + 1 ) + ";\n";// on deplace l'axe x
    gcode += "G4 P0.01" + ";\n";// pause de 10 millisecondes
    gcode += "G91 G0 Y" + (Number(y_lon) + 1) + ";\n";// on deplace l'axe Y
    gcode += "G38.2 X" + (Number(x_lon) + 1) + " F100" + ";\n";// Palpage rapide X
    gcode += "G91 G0 X-1" + ";\n";// mise en sécurité
    gcode += "G38.2 X3 F10" + ";\n";// Palpage LENT Y
    gcode += "G92 X-" + (Number(x_probe) + (Number(d_fraise) / 2)).toFixed(2) + ";\n";// on enregistre largeur du palpeur + diametre fraise/2
    gcode += "G91 G0 X-2" + ";\n";// mise en sécurité
    gcode += "G4 P0.01" + ";\n";// pause de 10 millisecondes
    gcode += "G90" + ";\n"; // on repasse en mode absolue
    gcode += "G0 Z" + (Number(z_probe) + 2) + ";\n"; // mise en sécurité de l'axe Z
    gcode += "G0 X0 Y0" + ";\n"; // on place X & Y en 0,0
    document.getElementById('gcode').innerHTML = gcode;
    filename = "PROBE_XYZ_FRAISE_D-" + d_fraise + "mm.nc";
};


// action sur le bouton User commands probe XY
document.querySelector("#gen_command_probe_xy").onclick = function () {
    // on verifi le formulaire
    if (verif_form() === false) { return; }

    // on genere le GCODE
    let gcode = "G21G91;"+"\n";
    gcode += "{var f = 50}{var r = "+Number(d_trou).toFixed(2) +"}{var d = " +Number(d_fraise).toFixed(2) +"}G38.2X{r}F{f};"+"\n";
    gcode += "{var q = vars.PRBx}G0X{-d};"+"\n";
    gcode += "G38.2X{-r};"+"\n";
    gcode += "G0X{(q - vars.PRBx) / 2};"+"\n";
    gcode += "G38.2Y{r};"+"\n";
    gcode += "{var q = vars.PRBy}G0Y{-d};"+"\n";
    gcode += "G38.2Y{-r};"+"\n";
    gcode += "G0Y{(q - vars.PRBy) / 2};";
    gcode += "G92X0Y0";
    document.getElementById('gcode').innerHTML = gcode;
    filename = "PROBE_Z_H-" + z_probe + "mm.nc";
};

    document.querySelector("#copy").onclick = function () {
        var content = document.getElementById('gcode').innerHTML;

        navigator.clipboard.writeText(content)
    };

    function download(file, text) {

        //creating an invisible element
        var element = document.createElement('a');
        element.setAttribute('href',
            'data:text/plain;charset=utf-8, '
            + encodeURIComponent(text));
        element.setAttribute('download', file);

        // Above code is equivalent to
        // <a href="path of file" download="file name">

        document.body.appendChild(element);

        //onClick property
        element.click();

        document.body.removeChild(element);
    }

    // Start file download.
    document.querySelector("#save").addEventListener("click", function () {
        // Generate download of hello.txt 
        // file with some content
        let text = document.querySelector("#gcode").innerHTML;


        download(filename, text);
    }, false);
</script>
